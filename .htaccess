# Security Configuration for IdeaNest
RewriteEngine On

# Security Headers - Block all insecure content
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# Force HTTPS for all mixed content
Header always set Upgrade-Insecure-Requests "1"

# HSTS - Enforce HTTPS
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Disable auto_prepend and auto_append to prevent script injection
php_flag auto_prepend_file off
php_flag auto_append_file off

# Hide sensitive files
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.json">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.lock">
    Order allow,deny
    Deny from all
</Files>

# Prevent access to includes directory
<Directory "includes">
    Order allow,deny
    Deny from all
</Directory>

# Prevent access to config directory
<Directory "config">
    Order allow,deny
    Deny from all
</Directory>

# Prevent PHP execution in upload directories
<Directory "user/uploads">
    php_flag engine off
</Directory>

<Directory "user/forms/uploads">
    php_flag engine off
</Directory>

# Block suspicious requests
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|Ãª|"|;|\?|\*|=$).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*("|'|<|>|\|{|\}).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(%0|%A|%B|%C|%D|%E|%F|127\.0).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(globals|encode|localhost|loopback).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(request|select|insert|union|declare).* [NC]
RewriteRule ^(.*)$ - [F,L]

# Prevent access to backup files
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Enable HTTPS redirect for production (force all traffic to HTTPS)
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteCond %{HTTP_HOST} !^127\.0\.0\.1 [NC]
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Block insecure external scripts and injection attempts
RewriteCond %{HTTP_REFERER} directfwd\.com [NC,OR]
RewriteCond %{HTTP_REFERER} jsinit [NC,OR]
RewriteCond %{HTTP_REFERER} jspark [NC,OR]
RewriteCond %{QUERY_STRING} directfwd [NC,OR]
RewriteCond %{QUERY_STRING} jsinit [NC]
RewriteRule ^(.*)$ - [F,L]

# Block requests to known injection domains
RewriteCond %{HTTP_HOST} ^(cdn\.jsinit\.directfwd\.com|.*\.directfwd\.com)$ [NC]
RewriteRule ^(.*)$ - [F,L]

# Custom error pages
ErrorDocument 403 /error_pages/403.html
ErrorDocument 404 /error_pages/404.html
ErrorDocument 500 /error_pages/500.html